steps:
  - bash: |
      set -e
      cd $(Build.BinariesDirectory)
      ARCH_URL=`curl -s https://mirrors.acm.wpi.edu/archlinux/iso/latest/ | egrep -o 'archlinux-bootstrap-([0-9._]+)-x86_64.tar.gz' | head -n1`
      echo https://mirrors.acm.wpi.edu/archlinux/iso/latest/$ARCH_URL
      curl https://mirrors.acm.wpi.edu/archlinux/iso/latest/$ARCH_URL -o arch.tar.gz
      sudo tar xzf arch.tar.gz
      sudo mount --bind ./root.x86_64/ ./root.x86_64/
      sudo cp -R $(Agent.BuildDirectory)/freetype2 ./root.x86_64/
      sudo mkdir -p ./root.x86_64/$(Build.BinariesDirectory)
      sudo mount --bind $(Build.BinariesDirectory) ./root.x86_64/$(Build.BinariesDirectory)
      cat << EOF | sudo ./root.x86_64/bin/arch-chroot ./root.x86_64/
      set -e
      echo 'Server = https://mirrors.kernel.org/archlinux/\$repo/os/\$arch' >> /etc/pacman.d/mirrorlist
      pacman-key --init 
      pacman-key --populate archlinux
      pacman -Syu --noconfirm base base-devel git gcc cmake harfbuzz zlib libpng xorg-server-xvfb imagemagick npm xorg-xwd
      npm install -g pretty-diff
      EOF
    displayName: 'Bootstrap Archlinux'
